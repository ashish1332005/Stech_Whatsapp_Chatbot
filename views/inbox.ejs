<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Stech Education Group | WhatsApp Team Inbox</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Custom scrollbar to match the theme */
Â  Â  Â  Â  ::-webkit-scrollbar { width: 6px; }
Â  Â  Â  Â  ::-webkit-scrollbar-thumb { background: #128c7e; border-radius: 3px; }
Â  Â  Â  Â  ::-webkit-scrollbar-thumb:hover { background: #075E54; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Set background for chat panel to mimic wallpaper area */
Â  Â  Â  Â  .chat-messaging-panel {
Â  Â  Â  Â  Â  Â  background-color: #ECE5DD; /* Light canvas/wallpaper color */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Container for chat bubbles */
Â  Â  Â  Â  .chat-area-container {Â 
Â  Â  Â  Â  Â  Â  max-height: calc(100vh - 120px); /* Adjusted for WhatsApp style top/bottom bars */
Â  Â  Â  Â  Â  Â  min-height: calc(100vh - 120px);
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Message Bubble Styling (WhatsApp Style) */
Â  Â  Â  Â  .message-bubble {
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 0.5px rgba(11, 20, 26, .13);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 8px 10px 8px 10px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  line-height: 19px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Inbound (User) Bubble */
Â  Â  Â  Â  .inbound-bubble {
Â  Â  Â  Â  Â  Â  background-color: #FFFFFF; /* White */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Outbound (Agent) Bubble */
Â  Â  Â  Â  .outbound-bubble {
Â  Â  Â  Â  Â  Â  background-color: #DCF8C6; /* Light green */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Time/Read Status */
Â  Â  Â  Â  .bubble-time {
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  Â  Â  color: #8c8c8c;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Mobile-first: Hide chat messages by default on small screens */
Â  Â  Â  Â  @media (max-width: 767px) {
Â  Â  Â  Â  Â  Â  .chat-messaging-panel-wrapper {
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-100 font-sans">
Â  Â  <div class="flex h-screen antialiased text-gray-800">
Â  Â  Â  Â  <div class="flex flex-col md:flex-row h-full w-full overflow-hidden">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="chat-list-panel"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â class="flex flex-col w-full md:w-80 bg-white flex-shrink-0Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-r border-gray-200 shadow-xl md:shadow-noneÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p-0 md:p-0 overflow-y-hidden">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center h-16 bg-[#075E54] text-white p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-extrabold text-xl">Stech Inbox</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full overflow-y-auto chat-list px-2 pt-2" id="chat-list-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="chat-status-message" class="text-xs text-gray-500 p-2">Loading chats...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-chat-area-mobile" class="md:hidden w-full p-2 bg-[#128c7e] text-white rounded-lg hover:bg-[#075E54] transition duration-150" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  View Active Chat
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="refresh-button" class="w-full mt-2 p-2 bg-[#25D366] text-white rounded-lg hover:bg-[#128c7e] transition duration-150 text-sm font-semibold shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ”„ Refresh Chats
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="chat-messaging-panel"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â class="chat-messaging-panel-wrapper flex flex-col flex-auto h-full w-full md:w-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col flex-auto flex-shrink-0 h-full w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center h-16 bg-[#075E54] text-white p-4 justify-between shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-chat-list-mobile" class="md:hidden text-white mr-3" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-center h-10 w-10 rounded-full bg-gray-200 text-gray-800 text-sm font-bold flex-shrink-0 mr-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  US
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="active-chat-header" class="text-base font-semibold">Select a Chat</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="chat-status-display" class="text-xs font-light text-gray-300">Offline / Bot Mode</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full overflow-y-auto p-3 chat-area-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col h-full chat-messages" id="messages-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-500 italic mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hidden md:inline">Click on a chat on the left to start.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="md:hidden">Select a chat from the list.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="input-area" class="flex flex-row items-center h-20 bg-gray-50 w-full px-4 border-t border-gray-200" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="message-input" placeholder="Type a message..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex w-full border border-gray-300 bg-white rounded-full focus:outline-none focus:border-[#25D366] pl-4 pr-16 h-10 text-sm shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ml-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="send-button"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex items-center justify-center bg-[#128c7e] hover:bg-[#075E54] rounded-full text-white h-10 w-10 flex-shrink-0 transition duration-150 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  let activeWaId = null;
Â  Â  Â  Â  let activeChatStatus = 'bot_mode'; // Track current chat status for header display

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  fetchChats();
Â  Â  Â  Â  Â  Â  document.getElementById('refresh-button').addEventListener('click', fetchChats);
Â  Â  Â  Â  Â  Â  document.getElementById('send-button').addEventListener('click', handleSendReply);
Â  Â  Â  Â  Â  Â  document.getElementById('message-input').addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleSendReply();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Responsive Handlers ---
Â  Â  Â  Â  Â  Â  const chatListPanel = document.getElementById('chat-list-panel');
Â  Â  Â  Â  Â  Â  const chatMessagingPanel = document.getElementById('chat-messaging-panel');
Â  Â  Â  Â  Â  Â  const toggleChatAreaBtn = document.getElementById('toggle-chat-area-mobile');
Â  Â  Â  Â  Â  Â  const toggleChatListBtn = document.getElementById('toggle-chat-list-mobile');

Â  Â  Â  Â  Â  Â  const showChatArea = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatListPanel.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatMessagingPanel.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatAreaBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatListBtn.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const showChatList = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatListPanel.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatMessagingPanel.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatListBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeWaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â toggleChatAreaBtn.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  toggleChatAreaBtn.addEventListener('click', showChatArea);
Â  Â  Â  Â  Â  Â  toggleChatListBtn.addEventListener('click', showChatList);

Â  Â  Â  Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth >= 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatListPanel.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatMessagingPanel.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatAreaBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatListBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (chatMessagingPanel.style.display === 'flex' && activeWaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showChatArea();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showChatList();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // --- End Responsive Handlers ---

Â  Â  Â  Â  Â  Â  // Auto-refresh chats every 10 secondsÂ 
Â  Â  Â  Â  Â  Â  setInterval(fetchChats, 10000);Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  // Utility function to format timestampÂ 
const formatTime = (timestamp) => {
Â  Â  // 1. If timestamp is missing or null, return empty
Â  Â  if (!timestamp) return '';
Â  Â Â 
Â  Â  const date = new Date(timestamp);
Â  Â Â 
Â  Â  // 2. IMPORTANT: Check if the date is valid.Â 
Â  Â  // If the database sent bad data, this prevents "Invalid Date" from showing.
Â  Â  if (isNaN(date.getTime())) {
Â  Â  Â  Â  return '';Â 
Â  Â  }

Â  Â  const now = new Date();
Â  Â Â 
Â  Â  // Check if the date is today
Â  Â  const isToday = date.getDate() === now.getDate() &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date.getMonth() === now.getMonth() &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date.getFullYear() === now.getFullYear();

Â  Â  const timeString = date.toLocaleTimeString('en-IN', {Â 
Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  minute: '2-digit',Â 
Â  Â  Â  Â  hour12: trueÂ 
Â  Â  });

Â  Â  if (isToday) {
Â  Â  Â  Â  // If today, show only time (e.g., "10:30 am")
Â  Â  Â  Â  return timeString;
Â  Â  } else {
Â  Â  Â  Â  // If older, show Date + Time (e.g., "01/12/25")
Â  Â  Â  Â  const dateString = date.toLocaleDateString('en-IN', {Â 
Â  Â  Â  Â  Â  Â  day: '2-digit',Â 
Â  Â  Â  Â  Â  Â  month: '2-digit',Â 
Â  Â  Â  Â  Â  Â  year: '2-digit'Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  return dateString; // Keeping list view clean with just date
Â  Â  }
};
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- 1. Fetch Chat List from Backend ---
Â  Â  Â  Â  async function fetchChats() {
Â  Â  Â  Â  Â  Â  const chatListContainer = document.getElementById('chat-list-container');
Â  Â  Â  Â  Â  Â  const statusMessage = document.getElementById('chat-status-message');
Â  Â  Â  Â  Â  Â  const toggleChatAreaBtn = document.getElementById('toggle-chat-area-mobile');
Â  Â  Â  Â  Â  Â  statusMessage.textContent = 'Refreshing...';
Â  Â  Â  Â  Â  Â  chatListContainer.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/chats');
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to fetch chats from API');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const chats = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (chats.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.textContent = 'No active chats found.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatAreaBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  chats.forEach(chat => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chatItem = createChatItem(chat);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatListContainer.appendChild(chatItem);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (activeWaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update the active chat's status and re-highlight
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentChat = chats.find(c => c._id === activeWaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentChat) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveChat(activeWaId, false, currentChat.lastStatus);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveChat(activeWaId, false, 'bot_mode'); // Default if not found
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleChatAreaBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching chats:", error);
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage.textContent = 'Error loading chats.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function createChatItem(chat) {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  const isLiveAgent = chat.lastStatus === 'live_agent_mode';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Subtle hover effect, no background color change needed for WhatsApp style list
Â  Â  Â  Â  Â  Â  item.className = `p-3 hover:bg-gray-100 transition duration-150 ease-in-out cursor-pointer border-b border-gray-100`;
Â  Â  Â  Â  Â  Â  item.dataset.waId = chat._id;
Â  Â  Â  Â  Â  Â  item.dataset.status = chat.lastStatus;

Â  Â  Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-center h-12 w-12 rounded-full bg-gray-200 text-gray-700 text-sm font-bold flex-shrink-0 mr-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${chat._id.substring(0, 2)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-base text-gray-900 truncate">${chat._id} </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-gray-500">${formatTime(chat.lastTimestamp)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mt-0.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 truncate">${chat.lastMessage}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs font-semibold px-2 py-0.5 rounded-fullÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isLiveAgent ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} ml-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isLiveAgent ? 'LIVE' : 'BOT'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  item.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  setActiveChat(chat._id, true, chat.lastStatus);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  return item;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. Fetch Message History ---
Â  Â  Â  Â  async function fetchChatHistory(waId, status) {
Â  Â  Â  Â  Â  Â  const messagesContainer = document.getElementById('messages-container');
Â  Â  Â  Â  Â  Â  document.getElementById('active-chat-header').textContent = waId;
Â  Â  Â  Â  Â  Â  document.getElementById('chat-status-display').textContent = status === 'live_agent_mode' ? 'Live Agent Mode' : 'Bot Mode';
Â  Â  Â  Â  Â  Â  messagesContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">Loading history...</p>';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/chats/${waId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to fetch chat history');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const history = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  messagesContainer.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  Â  Â  const messageWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.className = 'grid grid-cols-12 gap-y-2 w-full';

Â  Â  Â  Â  Â  Â  Â  Â  history.forEach(msg => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.appendChild(createMessageBubble(msg));
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  messagesContainer.appendChild(messageWrapper);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const chatArea = document.querySelector('.chat-area-container');
Â  Â  Â  Â  Â  Â  Â  Â  chatArea.scrollTop = chatArea.scrollHeight;

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching history:", error);
Â  Â  Â  Â  Â  Â  Â  Â  messagesContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Error: Could not load chat history for ${waId}.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function createMessageBubble(msg) {
Â  Â  Â  Â  Â  Â  const isAgent = msg.direction === 'outbound';
Â  Â  Â  Â  Â  Â  const bubble = document.createElement('div');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Layout based on sender (WhatsApp style layout)
Â  Â  Â  Â  Â  Â  bubble.className = isAgentÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? 'col-start-4 col-end-13 p-1 rounded-lg justify-self-end'Â 
Â  Â  Â  Â  Â  Â  Â  Â  : 'col-start-1 col-end-10 p-1 rounded-lg justify-self-start';

Â  Â  Â  Â  Â  Â  // Message content styling
Â  Â  Â  Â  Â  Â  const content = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble ${isAgent ? 'outbound-bubble' : 'inbound-bubble'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${msg.content}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bubble-time">${formatTime(msg.timestamp)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  bubble.innerHTML = content;
Â  Â  Â  Â  Â  Â  return bubble;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Updated setActiveChat signature
Â  Â  Â  Â  function setActiveChat(waId, shouldFetchHistory, status) {
Â  Â  Â  Â  Â  Â  activeWaId = waId;
Â  Â  Â  Â  Â  Â  activeChatStatus = status;
Â  Â  Â  Â  Â  Â  document.getElementById('input-area').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.getElementById('message-input').focus();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update Header Status
Â  Â  Â  Â  Â  Â  document.getElementById('active-chat-header').textContent = waId;
Â  Â  Â  Â  Â  Â  document.getElementById('chat-status-display').textContent = status === 'live_agent_mode' ? 'Live Agent Mode' : 'Bot Mode';

Â  Â  Â  Â  Â  Â  // Highlight the active chat in the list
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.chat-list > div').forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.remove('bg-gray-200', 'border-l-4', 'border-[#25D366]');
Â  Â  Â  Â  Â  Â  Â  Â  if (item.dataset.waId === waId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.classList.add('bg-gray-200', 'border-l-4', 'border-[#25D366]');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (shouldFetchHistory) {
Â  Â  Â  Â  Â  Â  Â  Â  fetchChatHistory(waId, status);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Switch to chat area on mobile after selection
Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chatListPanel = document.getElementById('chat-list-panel');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chatMessagingPanel = document.getElementById('chat-messaging-panel');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If chat list is currently visible, switch view
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (chatListPanel.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â chatListPanel.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â chatMessagingPanel.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('toggle-chat-list-mobile').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('toggle-chat-area-mobile').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('toggle-chat-area-mobile').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 3. Send Reply Logic (Updated to use new bubble style) ---
Â  Â  Â  Â  async function handleSendReply() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('message-input');
Â  Â  Â  Â  Â  Â  const message = input.value.trim();

Â  Â  Â  Â  Â  Â  if (!activeWaId || message === '') {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Reply attempt failed: Please select a chat and type a message.');Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Temporarily add message to UI
Â  Â  Â  Â  Â  Â  const tempMsg = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  content: message,Â 
Â  Â  Â  Â  Â  Â  Â  Â  direction: 'outbound',Â 
Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString()Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const messageWrapper = document.getElementById('messages-container').querySelector('.grid');
Â  Â  Â  Â  Â  Â  if (messageWrapper) {
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.appendChild(createMessageBubble(tempMsg));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // In case the message wrapper hasn't loaded yet
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('messages-container').innerHTML = '<div class="grid grid-cols-12 gap-y-2 w-full"></div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('messages-container').querySelector('.grid').appendChild(createMessageBubble(tempMsg));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  input.value = '';Â 
Â  Â  Â  Â  Â  Â  document.querySelector('.chat-area-container').scrollTop = document.querySelector('.chat-area-container').scrollHeight;Â 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/reply', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ waId: activeWaId, message: message })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("API Reply Error:", result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg.className = 'text-red-500 text-sm mt-2 text-center col-span-12';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg.textContent = `Error: Reply failed. Check console.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.appendChild(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchChatHistory(activeWaId, activeChatStatus);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Reply sent successfully:", result.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchChats();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fetch error during reply:", error);
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  errorMsg.className = 'text-red-500 text-sm mt-2 text-center col-span-12';
Â  Â  Â  Â  Â  Â  Â  Â  errorMsg.textContent = `Network Error: Could not reach server.`;
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.appendChild(errorMsg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
